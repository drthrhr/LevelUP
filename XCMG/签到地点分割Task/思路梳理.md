# 需求：签到表汇总 & 地点分割

预设场景可以是，在一个用于数据处理的专门的文件夹里：

- 放置一个 `签到表汇总AND地点分割.xlsm` 文件，其中存储了要执行的VBA代码，同时会把经过地点分割和汇总的表格存到其中的sheet1里。
- 把所有需要处理的Excel文件**复制**到该文件夹里，作为要处理的数据源



鼠标光标放到函数里，点运行，就能运行光标所在的VBA子过程函数了。

## 数据处理与分割

把地点数据给规整化，目标是规整化为 `xxxx省xxxx市xxxx街道` 的字符串；之后把对应信息分割到 `省` 、 `市` 、 `街道` 三个列中。

### 分割出 `省` 、 `市` 信息

#### 地点数据定位

> 数据条目不一定是从哪一行开始的；地点数据也不一定存在哪一列呢。所以得先明确地点数据所在的单元格位置。



#### ~~自治区处理~~

从左往右扫，扫到的第一个`自治区` 给替换为 `省`

#### ~~直辖市处理~~

从左往右扫，扫到的第一个直辖市名， `xx市` 给替换为 `xx省xx市`

直辖市包括：

```
上海市
重庆市
天津市
北京市
```

#### 分割出省、市信息

查了查资料，这是个比较常用的需求，已经有完善的解决方案了，不需要再自己各种处理

比如A列存了地址信息，那么可以用如下公式来分割出省、市信息（包含了自治区、直辖市等情况）：（以第1行为例）

- 省： `=LEFT(A1,MIN(FIND({"省","市","区"},A1&"省市区")))`
- 市： `=LEFT(SUBSTITUTE(A1,LEFT(A1,MIN(FIND({"省","市","区"},A1&"省市区"))),""),MIN(FIND({"市","区","县"},SUBSTITUTE(A1,LEFT(A1,MIN(FIND({"省","市","区"},A1&"省市区"))),"")&"市区县")))`



### 分割出 `街道` 信息

#### 对于已经包含了街道信息的数据



#### 对于不包含街道信息的数据

地点数据处理成 `xxxx省xxxx市` 的形式是没问题的；

但是有可能只通过简单的字符串处理做不成 `xxxx省xxxx市xxxx街道` 的形式，本身数据里面就不包含街道信息。可能只有通过调python脚本，基于[百度API](https://lbsyun.baidu.com/faq/api?title=webapi/guide/webservice-placeapiV3/interfaceDocumentV3#%E8%A1%8C%E6%94%BF%E5%8C%BA%E5%88%92%E5%8C%BA%E5%9F%9F%E6%A3%80%E7%B4%A2%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E)，检索这个地点（传参中应该address_result为false），再解析传回来的json格式结果，从 `results[0].town` 字段中才能得到街道信息。

VBA可以[通过命令行方式调用python脚本](https://docs.pingcode.com/baike/737391)，向其中传入参数，并读取脚本输出。从而把需要异常处理的地点数据传到python脚本里，再读取python脚本输出的街道信息。

- 先安装python及所需的库。

  - python：公司电脑上是`Python 3.8.10`；家里电脑上是`Python 3.12.7`，用的是 `M:\MProgramFiles\Anaconda3\python.exe` 。（记得配环境变量）

  - 安装requests库：（不能挂梯子）

    ```python
    python -m pip install requests
    ```

    

- 传入的参数：
  - 搜索区域，即 `xx市` 
  - 搜索的关键词，即数据本身

## 签到表汇总



## 地点分割
